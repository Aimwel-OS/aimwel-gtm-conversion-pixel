___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "categories": [
    "CONVERSIONS"
  ],
  "displayName": "Aimwel Conversion Measurement Tag",
  "brand": {
    "id": "github.com_Aimwel-OS",
    "displayName": "Aimwel Custom Template",
    "thumbnail": "data:image/jpeg;base64,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cmP1LANk7r7aIqxstCZjbSavYTh3T2cDckpwrmaWoddJjAC0HDkFjvCh6ToD6rkQKvCuQGSfXz2rDOv/AEjtUeiMeqdXzjOn/CO/4Qf0JhWMllObMeacuxGjYly1NKo2RPDyaMbgBRsy5aw4pL6Z0R3qz+Am252fhTKlkIbd4z+CZSVdhNICMhAKd3SgwuLtqTvLkgJRnpTaCZNQScYP5kdCpiAJKNWkigBLvVABcI1Z0RAXLvQku/w62UMZijPcoPGwMD7ehHelr96ATxMvJruHhpxPqiZ8sQEzENXOhudXo+vxg/oC37nPXq/38ZPiGNwK3DBpWgmlYoDkqGMDNitBhI0o8JSpAUhiDDbeS1BUPRn1xs9JxVNsZ3yEUmKN16SiMBc8GKZlYnKTGlHAZcwhAE5zThgEqkKgnrRcz1CCjzTwXXqEkD3U18pqxKO7WehssTIFrmdQkZY88ZPnZoqfoX07OldzS0rjVY8ryMRReCsiiwpzUKl5d9fwnilImW9JMcLPSfoyfQ/Y7+Gtr5w+lN5IKnnNECCz72oGwlZ0Lf3WXKT0IOFnpPmmGdnAfR0qMoRdhmLbopgw2YkVjlik3yl2GZFt2qOXfQGWOVK7QHux6SiqR62OxslB+5aPk2zRdJsFdASaLMHabzeAxes1aKjnovmz2h0wHOpdA2hzVNZIF0d3CjSYbQ5jUbcro5NA6UAI0AgCoh1ghGJdOapAEul4FAc55E6E/wBtZmWHK3lXvSiz0Q5KI86nBQDYJELukeP5K//aAAwDAQACAAMAAAAQ88888888888888888888888888888888888888888888888888888D1N7128888886c7BHfr8888d8sO4EF0WHDJ198888888bhjNM58888888svO/Os88888888888888888888888888888888888888888888888888888//EACMRAQACAgEDBAMAAAAAAAAAAAEAESExQSAwUBBR0fBhgaH/2gAIAQMBAT8Q8qy5qV8C1bHtFDcsC7m+vUF3ziZD4n1/qWKYIapwS9rjpyMVXoEjaZLZmIQBBiCYYgkGJ/L8RuAInAEVbVTJEpJv2BaD6S1XHZ9nxGKVMRrDN+wz8LlVBajjx/Ez5uWO8t//xAAoEQEAAgECBQMEAwAAAAAAAAABABEhMUFRgaHR8GGxwSAwUJEQceH/2gAIAQIBAT8Q/KoRG9F+btz0Wem3SNQBrsee8Vo2wpCvhEVT9YKoi+v3M8YG0D2/xnXnsyuRXK8+0MXjPftiWDRNPXtj6WCyp57/AMJhQb85xSptseLCNgDoeaVLCASz+hlogOThrL2Acn7nWwWVszw37QsrZXpv2nBIAa/M9OSZ0L8fYozdOa5JlNYim+/eIMpsx+4ycuiNVp7x5YOF0wOLnQvx9gpXDs6QTaN7VjznAqaaGxLmANLIUUA0DSU2JjO+Py3/xAAoEAEBAAIBAwMEAwADAAAAAAABEQAhMUFRYXGBoRAwkfAgcLFAwdH/2gAIAQEAAT8Q/soPFcYBy/Qe+abeLetvx3F84w5faIafQD2+gwHamJBdAbLzs4wxAd2/a75B6/8AE1oEk7l8hPzhnSOgq4HWOzkmbnUU7l8H5h9DaAZSJSLStWM4xV8zSFQgSInt9AHXcb8t0PKZoxAV/tUl8YbTdws7t0PMwila2v2VMfH32luA4hp9E+pYBnoJ3NHrafGaS1i6g19VjyP4ZrLhfCHztkg9IjYYS/rmHofrbl53i5yHTjHqCNC9xxi+4Rla7uLLzvExyTiuxGNYO9EcLJQt202+QT2+yOXabOxenmfwEXwQhq+DDOVL3FLRyPWYazaBlxvxJkbFoSZDTQZxi0yFY9k+uayx1Ug7W+PKLUTQV8wD2w4BxmwQvpXOn0ClKr5zT2HG4EvtlDMSXt9mekZqsMAegAAdtZuKSeqfVE+GmP8A66vCy2Ng1tEi56FdOOTceIR6md3bHzqySgkxpTnezNHKZpBz+0Hj+bNZJWUXvy+PysybsxjcBLFK8bw0w16j/HojsRHCdetE1BLCleNnfKZjfeF7IiI7ERyNIjgd1dBgAsAJvZuPznE370nVsfH0/Yd+frux9Vm7SSgAlwjH5wkygwEKCCrUNrr6TGZ8DAgtRCDswxP4miQArZWHQ6YATMhVBom4luiDlMfT6AJBQYs6ZDFQRDw0mhOdEt1dBIFG9RQUF5DEZeDiroBNolvEuPgjt0gKBQYqbmfL4/KzM0MFD3Y1asEuCbDCTpaxKVYJembXAyFkacppwovXUCJhAokLsUOOK5vZNlnCjyjTKvJjEuooKV5Gj6Z+w78/Xdj73y+Pys37zu+ij9f3YwFGS61f9YqFL4WAl87/ADhlCCAcDIjetdwVDwxJamntX4GvbP2Hfn67sfeKTLk4cF6KKd67YlgpmeUJIoaurhZI8UazfIoHrvpMaTIi/GNRUauqYRqiBoUvkULw7msCarsT8tu98iQct6gWkHXo4pBWSkFDiHSOxMZodO/Zj2jH/ZF0IoRW1INt3iFaqbqb4ChosJ6H3n8E4I/L6D8JR5xqT0R23SvopmxbwwyCyAdwGzkx77WgdaNcfRTCCAKGDeEdwpe5hy7EAiABwBiEmxnogcBohEAZzjrSjz7ab+MQfaii7DVfQP8AMK+/RNSHdS++IcKvIWDVMTonbDoCbkhBgV4+7+yv/9k\u003d"
  },
  "description": "Track Aimwel conversions effortlessly with our pixel for GTM",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "aimwel_api_endpoint",
    "displayName": "Aimwel API Endpoint URL (provided by Aimwel)",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "^https://.*"
        ],
        "errorMessage": "URL must start with \"https://\""
      },
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Please enter the provided Aimwel API endpoint URL in this field",
    "notSetText": "Please add the API endpoint URL to this field",
    "valueHint": "https://{{client name}}.t2.aimwel.com",
    "alwaysInSummary": true
  },
  {
    "type": "RADIO",
    "name": "event_type",
    "displayName": "Event Type",
    "radioItems": [
      {
        "value": "apply",
        "displayValue": "Apply click"
      },
      {
        "value": "view",
        "displayValue": "Job view"
      },
      {
        "value": "finished_apply",
        "displayValue": "Finished apply"
      },
      {
        "value": "registration",
        "displayValue": "Registration"
      }
    ],
    "simpleValueType": true,
    "help": "Please select the applicable event type",
    "valueValidators": [
      {
        "type": "NON_EMPTY",
        "errorMessage": "A choice is required"
      }
    ]
  },
  {
    "type": "RADIO",
    "name": "traffic_scope",
    "displayName": "Traffic scoping",
    "radioItems": [
      {
        "value": "all",
        "displayValue": "All traffic"
      },
      {
        "value": "aimwel",
        "displayValue": "Aimwel traffic"
      }
    ],
    "simpleValueType": true,
    "help": "Select a option to either send all performance conversion events to the endpoint or only Aimwel events. Default is all traffic (as per Aimwel guidelines).",
    "defaultValue": "all"
  },
  {
    "type": "SELECT",
    "name": "url_params_storage_duration_days",
    "displayName": "Attribution settings to match GA4",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": 30,
        "displayValue": "30 days"
      },
      {
        "value": 60,
        "displayValue": "60 days"
      },
      {
        "value": 90,
        "displayValue": "90 days"
      }
    ],
    "simpleValueType": true,
    "help": "The time period for the click-through attribution that should be aligned to your GA4 Attribution Setting.",
    "defaultValue": 90,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "alwaysInSummary": true
  },
  {
    "type": "CHECKBOX",
    "name": "test",
    "checkboxText": "Enable testing template",
    "simpleValueType": true,
    "displayName": "Template testing feature",
    "help": "Select this option to enable the template conversion event testing feature. Test conversion can be viewed here: https://try-tapi.aimwel.com/results.html. Please enter your API endpoint URL (example: https://\u003cclient_name\u003e.t2.aimwel.com) as input into the input field and click the \u0027Load Data\u0027 button.",
    "defaultValue": false,
    "alwaysInSummary": true
  },
  {
    "type": "CHECKBOX",
    "name": "debug",
    "checkboxText": "Enable logging to console",
    "simpleValueType": true,
    "displayName": "Logging for debugging",
    "help": "Enable this option to see logging messages in the browser\u0027s console for easy configuration debugging",
    "alwaysInSummary": true,
    "defaultValue": false
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "platformParameters",
    "displayName": "Platform parameters",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Platform parameter name",
        "name": "key",
        "type": "SELECT",
        "selectItems": [
          {
            "value": "job_id",
            "displayValue": "Job Id"
          },
          {
            "value": "brand",
            "displayValue": "Brand"
          }
        ],
        "isUnique": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "defaultValue": "",
        "displayName": "Platform parameter value",
        "name": "value",
        "type": "TEXT",
        "valueHint": "Select the (datalayer) variables which contain the required platform parameters",
        "isUnique": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ],
    "newRowButtonText": "Click to add platform parameter(s)",
    "help": "In this section you can add the platform parameters that should be included in the conversion event",
    "notSetText": "Please select the necessary platform parameter from the drop-down list.",
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "TABLE_ROW_COUNT",
        "args": [
          2,
          2
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Required necessary APIs
const getUrl = require('getUrl');
const sendPixel = require('sendPixel');
const encodeUri = require('encodeUri');
const setCookie = require('setCookie');
const getCookie = require('getCookieValues');
const logToConsole = require('logToConsole');
const getReferrerUrl = require('getReferrerUrl');
const generateRandom = require('generateRandom');
const encodeUriComponent = require('encodeUriComponent');
const getTimestampMillis = require('getTimestampMillis');
const currentTimestampInMilliseconds = getTimestampMillis();

// Template Version
const templateGitHubVersion = '658b701';

// Assign data fields to variables
const apiEndpoint = data.aimwel_api_endpoint;
const eventType = data.event_type;
const trafficScope = data.traffic_scope;
const testEndpoint = data.test;
const urlParamsStorageDurationDays = (1 * data.url_params_storage_duration_days) || 90;
const debugging = data.debug;

// Debugging option
const log = debugging ? logToConsole : (() => { });

// Set cookie names
const sessionCookieName = '_aimwel_session';
const paramsCookieName = '_aimwel_params';

// Get required cookie and query params values
const sessionIdFromCookie = getCookie(sessionCookieName)[0];
let paramsFromCookie = getCookie(paramsCookieName)[0];
const paramsFromUrl = getUrl('query');
const currentHost = getUrl('host');
const currentPath = getUrl('path');
const referrerHost = getReferrerUrl('host');
const referrerPath = getReferrerUrl('path');

// Set parameter name
const awId = 'aw_id';
const utmSource = 'utm_source';

// Define cookie parameters
const cookieOptionsSession = {
    domain: 'auto',
    path: '/',
    'max-age': 30 * 60,
    samesite: 'Lax',
    secure: true
};

let sessionId = sessionIdFromCookie;

if (!sessionId) {
    log('Session cookie nonexistent: creating sessionId and session cookie');
    sessionId = generateRandom(1000000, 9999999) + '.' + generateRandom(1000000, 9999999);
    setCookie(sessionCookieName, sessionId, cookieOptionsSession);
} else {
    log('Session cookie exists: extending lifetime');
    setCookie(sessionCookieName, sessionId, cookieOptionsSession);
}

const cookieOptionsParams = {
    domain: 'auto',
    path: '/',
    'max-age': urlParamsStorageDurationDays * 24 * 60 * 60,
    samesite: 'Lax',
    secure: true
};

const urlContainsAimwelParams = paramsFromUrl.indexOf(awId) !== -1;
const urlContainsUtmParams = paramsFromUrl.indexOf(utmSource) !== -1;
const urlContainsParams = urlContainsAimwelParams || urlContainsUtmParams;

if (urlContainsParams) {
    log('Campaign parameters detected in url: creating or overwriting params cookie');
    setCookie(paramsCookieName, paramsFromUrl, cookieOptionsParams);
    paramsFromCookie = paramsFromUrl;
} else {
    if (!paramsFromCookie) {
        log('Campaign params cookie nonexistent and URL does not contain campaign params: continuing without');
    } else {
        log('Campaign params cookie exists: continuing with existing');
    }
}

let cookieContainsAimwelParams, cookieContainsUtmParams, cookieContainsParams;

if (paramsFromCookie) {
    cookieContainsAimwelParams = paramsFromCookie.indexOf(awId) !== -1;
    cookieContainsUtmParams = paramsFromCookie.indexOf(utmSource) !== -1;
    cookieContainsParams = cookieContainsAimwelParams || cookieContainsUtmParams;
}

// Function to strip trailing slash from endpoint url input field value
function stripTrailingSlash(endPoint) {
    if (endPoint.charAt(endPoint.length - 1) == "/") {
        log('Removing trailing forward slash in API endpoint');
        endPoint = endPoint.substring(0, endPoint.length - 1);
    }
    return endPoint;
}

let endPointUrl;

if (testEndpoint) {
    log('Testing feature enabled: test endpoint active');
    endPointUrl = encodeUri(stripTrailingSlash(apiEndpoint) + '/test');
} else {
    endPointUrl = encodeUri(stripTrailingSlash(apiEndpoint));
}

// Function to build URL with required and additional components
function buildUrl() {
    let url = endPointUrl;

    url += '?timestamp=' + currentTimestampInMilliseconds;
    url += '&session_id=' + sessionId;
    url += '&event_type=' + eventType;
    url += '&v=' + templateGitHubVersion;
    url += '&attr_window=' + urlParamsStorageDurationDays;
    url += '&ref_host=' + referrerHost;
    url += '&ref_path=' + referrerPath;
    url += '&curr_host=' + currentHost;
    url += '&curr_path=' + currentPath;

    data.platformParameters.forEach(param => {
      if (param.key) {
          if (param.key === 'job_id' && !param.value) {
              param.value = 'unknown';
              log('The job id parameter value seems to be missing/empty, this is a required value: please check how the job id value is set and/or if it is available at the moment this tag is fired');
          }

          if (param.value) {
              url += '&' + encodeUriComponent(param.key) + '=' + encodeUriComponent(param.value);
          }
        }
    });

    if (paramsFromCookie) {
        url += '&' + paramsFromCookie;
    } else {
        log('Campaign params omitted in URL builder due to nonexistent campaign params cookie or nonexistent url campaign parameters');
    }

    return url;
}

// Placeholder URL variable; only build full URL if sending pixel
let fullUrl;

// Build URL and Send GET request if conditions are met
if (paramsFromCookie && cookieContainsAimwelParams) {
    fullUrl = buildUrl();
    
    if (testEndpoint) {
      log('Sending pixel to test endpoint: Aimwel campaign');
    } else {
        log('Sending pixel: Aimwel campaign');
    }
  
    sendPixel(fullUrl + '&t=aimwel', data.gtmOnSuccess, data.gtmOnFailure);
    log('URL sent: ' + fullUrl + '&t=aimwel');
} else {
    if (trafficScope == 'all' && (cookieContainsUtmParams || !paramsFromCookie)) {
        fullUrl = buildUrl();
        
        if (testEndpoint) {
          log('Sending pixel to test endpoint: all traffic allowed');
        } else {
          log('Sending pixel: all traffic allowed');
        }

        sendPixel(fullUrl + '&t=all', data.gtmOnSuccess, data.gtmOnFailure);
        log('URL sent: ' + fullUrl + '&t=all');
    } else if (trafficScope == 'aimwel') {
        log('Not sending pixel: limited traffic allowed');
        data.gtmOnSuccess();
    } else {
        log('Not sending pixel: no campaign params present and traffic scoping incorrect/unknown');
        data.gtmOnSuccess();
    }
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "path",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "query",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "host",
          "value": {
            "type": 8,
            "boolean": true
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_referrer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "path",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "host",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: newUser+BothUrlParams&NoCookieParams
  code: "const mockData = getMockData({\n  event_type: 'view',\n  debug: true,\n});\n\
    \nconst expected = 'https://www.example.com?timestamp=321&session_id=1234.1234&event_type=view&v=964964e&attr_window=90&ref_host=google.com&ref_path=/job_123.html&curr_host=example.com&curr_path=/job_123.html&job_id=test_id_123&brand=test_for_template&utm_source=test&utm_medium=test&aw_id=123&t=aimwel';\n\
    \nmock('getCookieValues', (name) => {\n  if (name === session) {\n    return [undefined];\n\
    \  }\n  if (name === params) { \n    return [undefined];\n  }\n});\n\nmock('getUrl',\
    \ component => {\n  if (component === 'query') {\n    return getUrlData.params_full;\n\
    \  } else if (component === 'host') {\n    return getUrlData.curr_host;\n  } else\
    \ if (component === 'path') {\n    return getUrlData.curr_path;\n  } fail(\"getUrl\
    \ failed\");\n});\n\nmock('getReferrerUrl', component => {\n  if (component ===\
    \ 'host') {\n    return getReferrerData.ref_host;\n  } else if (component ===\
    \ 'path') {\n    return getReferrerData.ref_path;\n  } fail(\"getReferrer failed\"\
    );\n});\n\nmock('setCookie', (name, value, options) => {\n  if (name === session)\
    \ {\n    cookies[name] = value;\n  }\n  if (name === params) {\n    cookies[name]\
    \ = value;\n  }\n});\n\nmock('sendPixel', (url, gtmOnSuccess, gtmOnFailure) =>\
    \ {              \n  assertThat(url).isEqualTo(expected);  \n  gtmOnSuccess();\n\
    });\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\nassertApi('setCookie').wasCalledWith(session,\
    \ cookies[session], cookieOptionsSession);\nassertApi('setCookie').wasCalledWith(params,\
    \ cookies[params], cookieOptionsParams);"
- name: newUser+UtmUrlParams&NoCookieParamsAllTraffic
  code: "const mockData = getMockData({\n  event_type: 'view',\n  traffic_scope: 'all',\n\
    \  debug: true,\n});\n\nconst expected = 'https://www.example.com?timestamp=321&session_id=1234.1234&event_type=view&v=964964e&attr_window=90&ref_host=google.com&ref_path=/job_123.html&curr_host=example.com&curr_path=/job_123.html&job_id=test_id_123&brand=test_for_template&utm_source=test&utm_medium=test&t=all';\n\
    \nmock('getCookieValues', (name) => {\n  if (name === session) {\n    return [undefined];\n\
    \  }\n  if (name === params) { \n    return [undefined];\n  }\n});\n\nmock('getUrl',\
    \ component => {\n  if (component === 'query') {\n    return getUrlData.params_utm;\n\
    \  } else if (component === 'host') {\n    return getUrlData.curr_host;\n  } else\
    \ if (component === 'path') {\n    return getUrlData.curr_path;\n  } fail(\"getUrl\
    \ failed\");\n});\n\nmock('getReferrerUrl', component => {\n  if (component ===\
    \ 'host') {\n    return getReferrerData.ref_host;\n  } else if (component ===\
    \ 'path') {\n    return getReferrerData.ref_path;\n  } fail(\"getReferrer failed\"\
    );\n});\n\nmock('setCookie', (name, value, options) => {\n  if (name === session)\
    \ {\n    cookies[name] = value;\n  }\n  if (name === params) {\n    cookies[name]\
    \ = value;\n  }\n});\n\nmock('sendPixel', (url, gtmOnSuccess, gtmOnFailure) =>\
    \ {              \n  assertThat(url).isEqualTo(expected);  \n  gtmOnSuccess();\n\
    });\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\nassertApi('setCookie').wasCalledWith(session,\
    \ cookies[session], cookieOptionsSession);\nassertApi('setCookie').wasCalledWith(params,\
    \ cookies[params], cookieOptionsParams);"
- name: newUser+UtmUrlParams&NoCookieParamsAimwelTraffic
  code: "const mockData = getMockData({\n  event_type: 'view',\n  traffic_scope: 'aimwel',\n\
    \  debug: true,\n});\n\nconst expected = 'https://www.example.com?timestamp=321&session_id=1234.1234&event_type=view&v=964964e&attr_window=90&ref_host=google.com&ref_path=/job_123.html&curr_host=example.com&curr_path=/job_123.html&job_id=test_id_123&brand=test_for_template&utm_source=test&utm_medium=test&t=all';\n\
    \nmock('getCookieValues', (name) => {\n  if (name === session) {\n    return [undefined];\n\
    \  }\n  if (name === params) { \n    return [undefined];\n  }\n});\n\nmock('getUrl',\
    \ component => {\n  if (component === 'query') {\n    return getUrlData.params_utm;\n\
    \  } else if (component === 'host') {\n    return getUrlData.curr_host;\n  } else\
    \ if (component === 'path') {\n    return getUrlData.curr_path;\n  } fail(\"getUrl\
    \ failed\");\n});\n\nmock('getReferrerUrl', component => {\n  if (component ===\
    \ 'host') {\n    return getReferrerData.ref_host;\n  } else if (component ===\
    \ 'path') {\n    return getReferrerData.ref_path;\n  } fail(\"getReferrer failed\"\
    );\n});\n\nmock('setCookie', (name, value, options) => {\n  if (name === session)\
    \ {\n    cookies[name] = value;\n  }\n  if (name === params) {\n    cookies[name]\
    \ = value;\n  }\n});\n\nmock('sendPixel', (url, gtmOnSuccess, gtmOnFailure) =>\
    \ {              \n  assertThat(url).isEqualTo(expected);  \n  gtmOnSuccess();\n\
    });\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\nassertApi('setCookie').wasCalledWith(session,\
    \ cookies[session], cookieOptionsSession);\nassertApi('setCookie').wasCalledWith(params,\
    \ cookies[params], cookieOptionsParams);"
- name: newUser+NoUrlParams&NoCookieParams
  code: "const mockData = getMockData({\n  event_type: 'view',\n  traffic_scope: 'all',\n\
    \  debug: true,\n});\n\nconst expected = 'https://www.example.com?timestamp=321&session_id=1234.1234&event_type=view&v=964964e&attr_window=90&ref_host=google.com&ref_path=/job_123.html&curr_host=example.com&curr_path=/job_123.html&job_id=test_id_123&brand=test_for_template&t=all';\n\
    \nmock('getCookieValues', (name) => {\n  if (name === session) {\n    return [undefined];\n\
    \  }\n  if (name === params) { \n    return [undefined];\n  }\n});\n\nmock('getUrl',\
    \ component => {\n  if (component === 'query') {\n    return getUrlData.params_empty;\n\
    \  } else if (component === 'host') {\n    return getUrlData.curr_host;\n  } else\
    \ if (component === 'path') {\n    return getUrlData.curr_path;\n  } fail(\"getUrl\
    \ failed\");\n});\n\nmock('getReferrerUrl', component => {\n  if (component ===\
    \ 'host') {\n    return getReferrerData.ref_host;\n  } else if (component ===\
    \ 'path') {\n    return getReferrerData.ref_path;\n  } fail(\"getReferrer failed\"\
    );\n});\n\nmock('setCookie', (name, value, options) => {\n  if (name === session)\
    \ {\n    cookies[name] = value;\n  }\n  if (name === params) {\n    cookies[name]\
    \ = value;\n  }\n});\n\nmock('sendPixel', (url, gtmOnSuccess, gtmOnFailure) =>\
    \ {              \n  assertThat(url).isEqualTo(expected);  \n  gtmOnSuccess();\n\
    });\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\nassertApi('setCookie').wasCalledWith(session,\
    \ cookies[session], cookieOptionsSession);\nassertApi('setCookie').wasNotCalledWith(params,\
    \ cookies[params], cookieOptionsParams);"
- name: returningUser+BothUrlParams&BothCookieParams
  code: "const mockData = getMockData({\n  event_type: 'view',\n  traffic_scope: 'all',\n\
    \  debug: true,\n});\n\nconst expected = 'https://www.example.com?timestamp=321&session_id=5678.5678&event_type=view&v=964964e&attr_window=90&ref_host=google.com&ref_path=/job_123.html&curr_host=example.com&curr_path=/job_123.html&job_id=test_id_123&brand=test_for_template&utm_source=test&utm_medium=test&aw_id=123&t=aimwel';\n\
    \nmock('getCookieValues', (name) => {\n  if (name === session) {\n    return ['5678.5678'];\n\
    \  }\n  if (name === params) { \n    return [getUrlData.params_alt_full];\n  }\n\
    });\n\nmock('getUrl', component => {\n  if (component === 'query') {\n    return\
    \ getUrlData.params_full;\n  } else if (component === 'host') {\n    return getUrlData.curr_host;\n\
    \  } else if (component === 'path') {\n    return getUrlData.curr_path;\n  } fail(\"\
    getUrl failed\");\n});\n\nmock('getReferrerUrl', component => {\n  if (component\
    \ === 'host') {\n    return getReferrerData.ref_host;\n  } else if (component\
    \ === 'path') {\n    return getReferrerData.ref_path;\n  } fail(\"getReferrer\
    \ failed\");\n});\n\nmock('setCookie', (name, value, options) => {\n  if (name\
    \ === session) {\n    cookies[name] = value;\n  }\n  if (name === params) {\n\
    \    cookies[name] = value;\n  }\n});\n\nmock('sendPixel', (url, gtmOnSuccess,\
    \ gtmOnFailure) => {\n  assertThat(url).isEqualTo(expected);\n  gtmOnSuccess();\n\
    });\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\nassertApi('setCookie').wasCalledWith(session,\
    \ cookies[session], cookieOptionsSession);\nassertApi('setCookie').wasCalledWith(params,\
    \ cookies[params], cookieOptionsParams);"
- name: returningUser+UtmUrlParams&UtmCookieParams
  code: "const mockData = getMockData({\n  event_type: 'view',\n  traffic_scope: 'all',\n\
    \  debug: true,\n});\n\nconst expected = 'https://www.example.com?timestamp=321&session_id=1234.1234&event_type=view&v=964964e&attr_window=90&ref_host=google.com&ref_path=/job_123.html&curr_host=example.com&curr_path=/job_123.html&job_id=test_id_123&brand=test_for_template&utm_source=test&utm_medium=test&t=all';\n\
    \nmock('getCookieValues', (name) => {\n  if (name === session) {\n    return ['1234.1234'];\n\
    \  }\n  if (name === params) { \n    return getUrlData.params_utm;\n  }\n});\n\
    \nmock('getUrl', component => {\n  if (component === 'query') {\n    return getUrlData.params_utm;\n\
    \  } else if (component === 'host') {\n    return getUrlData.curr_host;\n  } else\
    \ if (component === 'path') {\n    return getUrlData.curr_path;\n  } fail(\"getUrl\
    \ failed\");\n});\n\nmock('getReferrerUrl', component => {\n  if (component ===\
    \ 'host') {\n    return getReferrerData.ref_host;\n  } else if (component ===\
    \ 'path') {\n    return getReferrerData.ref_path;\n  } fail(\"getReferrer failed\"\
    );\n});\n\nmock('setCookie', (name, value, options) => {\n  if (name === session)\
    \ {\n    cookies[name] = value;\n  }\n  if (name === params) {\n    cookies[name]\
    \ = value;\n  }\n});\n\nmock('sendPixel', (url, gtmOnSuccess, gtmOnFailure) =>\
    \ {              \n  assertThat(url).isEqualTo(expected);  \n  gtmOnSuccess();\n\
    });\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\nassertApi('setCookie').wasCalledWith(session,\
    \ cookies[session], cookieOptionsSession);\nassertApi('setCookie').wasCalledWith(params,\
    \ cookies[params], cookieOptionsParams);"
- name: returningUser+NoUrlParams&AwIdCookieParams
  code: "const mockData = getMockData({\n  event_type: 'view',\n  traffic_scope: 'all',\n\
    \  debug: true,\n});\n\nconst expected = 'https://www.example.com?timestamp=321&session_id=1234.1234&event_type=view&v=964964e&attr_window=90&ref_host=google.com&ref_path=/job_123.html&curr_host=example.com&curr_path=/job_123.html&job_id=test_id_123&brand=test_for_template&aw_id=456&t=aimwel';\n\
    \nmock('getCookieValues', (name) => {\n  if (name === session) {\n    return ['1234.1234'];\n\
    \  }\n  if (name === params) { \n    return [getUrlData.params_alt_awid];\n  }\n\
    });\n\nmock('getUrl', component => {\n  if (component === 'query') {\n    return\
    \ getUrlData.params_empty;\n  } else if (component === 'host') {\n    return getUrlData.curr_host;\n\
    \  } else if (component === 'path') {\n    return getUrlData.curr_path;\n  } fail(\"\
    getUrl failed\");\n});\n\nmock('getReferrerUrl', component => {\n  if (component\
    \ === 'host') {\n    return getReferrerData.ref_host;\n  } else if (component\
    \ === 'path') {\n    return getReferrerData.ref_path;\n  } fail(\"getReferrer\
    \ failed\");\n});\n\nmock('setCookie', (name, value, options) => {\n  if (name\
    \ === session) {\n    cookies[name] = value;\n  }\n  if (name === params) {\n\
    \    cookies[name] = value;\n  }\n});\n\nmock('sendPixel', (url, gtmOnSuccess,\
    \ gtmOnFailure) => {              \n  assertThat(url).isEqualTo(expected);\n \
    \ gtmOnSuccess();\n});\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('setCookie').wasCalledWith(session, cookies[session], cookieOptionsSession);\n\
    assertApi('setCookie').wasNotCalledWith(params, cookies[params], cookieOptionsParams);"
- name: unitTestFunctionBuildUrlWithoutCookieParamsAllTraffic
  code: "const mockData = getMockData({\n  event_type: 'view',\n  traffic_scope: 'all',\n\
    \  debug: true,\n});\n\nconst expected = 'https://www.example.com?timestamp=321&session_id=1234.1234&event_type=view&v=964964e&attr_window=90&ref_host=google.com&ref_path=/job_123.html&curr_host=example.com&curr_path=/job_123.html&job_id=test_id_123&brand=test_for_template&t=all';\n\
    \nmock('getCookieValues', (name) => {\n  if (name === session) {\n    return ['1234.1234'];\n\
    \  }\n  if (name === params) { \n    return [getUrlData.params_empty];\n  }\n\
    });\n\nmock('getUrl', component => {\n  if (component === 'query') {\n    return\
    \ getUrlData.params_empty;\n  } else if (component === 'host') {\n    return getUrlData.curr_host;\n\
    \  } else if (component === 'path') {\n    return getUrlData.curr_path;\n  } fail(\"\
    getUrl failed\");\n});\n\nmock('getReferrerUrl', component => {\n  if (component\
    \ === 'host') {\n    return getReferrerData.ref_host;\n  } else if (component\
    \ === 'path') {\n    return getReferrerData.ref_path;\n  } fail(\"getReferrer\
    \ failed\");\n});\n\nmock('setCookie', (name, value, options) => {\n  if (name\
    \ === session) {\n    cookies[name] = value;\n  }\n  if (name === params) {\n\
    \    cookies[name] = value;\n  }\n});\n\nmock('sendPixel', (url, gtmOnSuccess,\
    \ gtmOnFailure) => {              \n  assertThat(url).isEqualTo(expected);\n \
    \ gtmOnSuccess();\n});\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('setCookie').wasCalledWith(session, cookies[session], cookieOptionsSession);\n\
    assertApi('setCookie').wasNotCalledWith(params, cookies[params], cookieOptionsParams);"
- name: unitTestFunctionBuildUrlWithoutCookieParamsAimwelTraffic
  code: "const mockData = getMockData({\n  event_type: 'view',\n  traffic_scope: 'aimwel',\n\
    \  debug: true,\n});\n\nconst expected = 'https://www.example.com?timestamp=321&session_id=1234.1234&event_type=view&v=964964e&attr_window=90&ref_host=google.com&ref_path=/job_123.html&curr_host=example.com&curr_path=/job_123.html&job_id=test_id_123&brand=test_for_template&t=all';\n\
    \nmock('getCookieValues', (name) => {\n  if (name === session) {\n    return ['1234.1234'];\n\
    \  }\n  if (name === params) { \n    return [getUrlData.params_empty];\n  }\n\
    });\n\nmock('getUrl', component => {\n  if (component === 'query') {\n    return\
    \ getUrlData.params_empty;\n  } else if (component === 'host') {\n    return getUrlData.curr_host;\n\
    \  } else if (component === 'path') {\n    return getUrlData.curr_path;\n  } fail(\"\
    getUrl failed\");\n});\n\nmock('getReferrerUrl', component => {\n  if (component\
    \ === 'host') {\n    return getReferrerData.ref_host;\n  } else if (component\
    \ === 'path') {\n    return getReferrerData.ref_path;\n  } fail(\"getReferrer\
    \ failed\");\n});\n\nmock('setCookie', (name, value, options) => {\n  if (name\
    \ === session) {\n    cookies[name] = value;\n  }\n  if (name === params) {\n\
    \    cookies[name] = value;\n  }\n});\n\nmock('sendPixel', (url, gtmOnSuccess,\
    \ gtmOnFailure) => {              \n  assertThat(url).isEqualTo(expected);\n \
    \ gtmOnSuccess();\n});\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('setCookie').wasCalledWith(session, cookies[session], cookieOptionsSession);\n\
    assertApi('setCookie').wasNotCalledWith(params, cookies[params], cookieOptionsParams);"
- name: unitTestFunctionBuildUrlWithUtmCookieParamsAllTraffic
  code: "const mockData = getMockData({\n  event_type: 'view',\n  traffic_scope: 'all',\n\
    \  debug: true,\n});\n\nconst expected = 'https://www.example.com?timestamp=321&session_id=5678.5678&event_type=view&v=964964e&attr_window=90&ref_host=google.com&ref_path=/job_123.html&curr_host=example.com&curr_path=/job_123.html&job_id=test_id_123&brand=test_for_template&utm_source=example&utm_medium=example&t=all';\n\
    \nmock('getCookieValues', (name) => {\n  if (name === session) {\n    return ['5678.5678'];\n\
    \  }\n  if (name === params) { \n    return [getUrlData.params_utm];\n  }\n});\n\
    \nmock('getUrl', component => {\n  if (component === 'query') {\n    return getUrlData.params_alt_utm;\n\
    \  } else if (component === 'host') {\n    return getUrlData.curr_host;\n  } else\
    \ if (component === 'path') {\n    return getUrlData.curr_path;\n  } fail(\"getUrl\
    \ failed\");\n});\n\nmock('getReferrerUrl', component => {\n  if (component ===\
    \ 'host') {\n    return getReferrerData.ref_host;\n  } else if (component ===\
    \ 'path') {\n    return getReferrerData.ref_path;\n  } fail(\"getReferrer failed\"\
    );\n});\n\nmock('setCookie', (name, value, options) => {\n  if (name === session)\
    \ {\n    cookies[name] = value;\n  }\n  if (name === params) {\n    cookies[name]\
    \ = value;\n  }\n});\n\nmock('sendPixel', (url, gtmOnSuccess, gtmOnFailure) =>\
    \ {              \n  assertThat(url).isEqualTo(expected);\n  gtmOnSuccess();\n\
    });\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\nassertApi('setCookie').wasCalledWith(session,\
    \ cookies[session], cookieOptionsSession);\nassertApi('setCookie').wasCalledWith(params,\
    \ cookies[params], cookieOptionsParams);"
- name: unitTestFunctionBuildUrlWithAwIdCookieParamsAllTraffic
  code: "const mockData = getMockData({\n  event_type: 'view',\n  traffic_scope: 'all',\n\
    \  debug: true,\n});\n\nconst expected = 'https://www.example.com?timestamp=321&session_id=5678.5678&event_type=view&v=964964e&attr_window=90&ref_host=google.com&ref_path=/job_123.html&curr_host=example.com&curr_path=/job_123.html&job_id=test_id_123&brand=test_for_template&utm_source=example&utm_medium=example&aw_id=456&t=aimwel';\n\
    \nmock('getCookieValues', (name) => {\n  if (name === session) {\n    return ['5678.5678'];\n\
    \  }\n  if (name === params) { \n    return [getUrlData.params_full];\n  }\n});\n\
    \nmock('getUrl', component => {\n  if (component === 'query') {\n    return getUrlData.params_alt_full;\n\
    \  } else if (component === 'host') {\n    return getUrlData.curr_host;\n  } else\
    \ if (component === 'path') {\n    return getUrlData.curr_path;\n  } fail(\"getUrl\
    \ failed\");\n});\n\nmock('getReferrerUrl', component => {\n  if (component ===\
    \ 'host') {\n    return getReferrerData.ref_host;\n  } else if (component ===\
    \ 'path') {\n    return getReferrerData.ref_path;\n  } fail(\"getReferrer failed\"\
    );\n});\n\nmock('setCookie', (name, value, options) => {\n  if (name === session)\
    \ {\n    cookies[name] = value;\n  }\n  if (name === params) {\n    cookies[name]\
    \ = value;\n  }\n});\n\nmock('sendPixel', (url, gtmOnSuccess, gtmOnFailure) =>\
    \ {              \n  assertThat(url).isEqualTo(expected);\n  gtmOnSuccess();\n\
    });\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\nassertApi('setCookie').wasCalledWith(session,\
    \ cookies[session], cookieOptionsSession);\nassertApi('setCookie').wasCalledWith(params,\
    \ cookies[params], cookieOptionsParams);"
- name: unitTestFunctionBuildUrlWithUtmCookieParamsAimwelTraffic
  code: "const mockData = getMockData({\n  event_type: 'view',\n  traffic_scope: 'aimwel',\n\
    \  debug: true,\n});\n\nconst expected = 'https://www.example.com?timestamp=321&session_id=5678.5678&event_type=view&v=964964e&attr_window=90&ref_host=google.com&ref_path=/job_123.html&curr_host=example.com&curr_path=/job_123.html&job_id=test_id_123&brand=test_for_template&utm_source=example&utm_medium=example&t=all';\n\
    \nmock('getCookieValues', (name) => {\n  if (name === session) {\n    return ['5678.5678'];\n\
    \  }\n  if (name === params) { \n    return [getUrlData.params_utm];\n  }\n});\n\
    \nmock('getUrl', component => {\n  if (component === 'query') {\n    return getUrlData.params_alt_utm;\n\
    \  } else if (component === 'host') {\n    return getUrlData.curr_host;\n  } else\
    \ if (component === 'path') {\n    return getUrlData.curr_path;\n  } fail(\"getUrl\
    \ failed\");\n});\n\nmock('getReferrerUrl', component => {\n  if (component ===\
    \ 'host') {\n    return getReferrerData.ref_host;\n  } else if (component ===\
    \ 'path') {\n    return getReferrerData.ref_path;\n  } fail(\"getReferrer failed\"\
    );\n});\n\nmock('setCookie', (name, value, options) => {\n  if (name === session)\
    \ {\n    cookies[name] = value;\n  }\n  if (name === params) {\n    cookies[name]\
    \ = value;\n  }\n});\n\nmock('sendPixel', (url, gtmOnSuccess, gtmOnFailure) =>\
    \ {              \n  assertThat(url).isEqualTo(expected);\n  gtmOnSuccess();\n\
    });\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\nassertApi('setCookie').wasCalledWith(session,\
    \ cookies[session], cookieOptionsSession);\nassertApi('setCookie').wasCalledWith(params,\
    \ cookies[params], cookieOptionsParams);"
- name: unitTestFunctionStripTrailingSlash
  code: "const mockData = getMockData({\n  aimwel_api_endpoint: 'https://www.example.com/',\n\
    \  event_type: 'view',\n  traffic_scope: 'all',\n  debug: true,\n});\n\nconst\
    \ expected = 'https://www.example.com?timestamp=321&session_id=1234.1234&event_type=view&v=964964e&attr_window=90&ref_host=google.com&ref_path=/job_123.html&curr_host=example.com&curr_path=/job_123.html&job_id=test_id_123&brand=test_for_template&t=all';\n\
    \nmock('getCookieValues', (name) => {\n  if (name === session) {\n    return ['1234.1234'];\n\
    \  }\n  if (name === params) { \n    return [getUrlData.params_empty];\n  }\n\
    });\n\nmock('getUrl', component => {\n  if (component === 'query') {\n    return\
    \ getUrlData.params_empty;\n  } else if (component === 'host') {\n    return getUrlData.curr_host;\n\
    \  } else if (component === 'path') {\n    return getUrlData.curr_path;\n  } fail(\"\
    getUrl failed\");\n});\n\nmock('getReferrerUrl', component => {\n  if (component\
    \ === 'host') {\n    return getReferrerData.ref_host;\n  } else if (component\
    \ === 'path') {\n    return getReferrerData.ref_path;\n  } fail(\"getReferrer\
    \ failed\");\n});\n\nmock('setCookie', (name, value, options) => {\n  if (name\
    \ === session) {\n    cookies[name] = value;\n  }\n  if (name === params) {\n\
    \    cookies[name] = value;\n  }\n});\n\nmock('sendPixel', (url, gtmOnSuccess,\
    \ gtmOnFailure) => {              \n  assertThat(url).isEqualTo(expected);\n \
    \ gtmOnSuccess();\n});\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('setCookie').wasCalledWith(session, cookies[session], cookieOptionsSession);\n\
    assertApi('setCookie').wasNotCalledWith(params, cookies[params], cookieOptionsParams);"
- name: unitTestFunctionTestEndpointActive
  code: "const mockData = getMockData({\n  aimwel_api_endpoint: 'https://www.example.com/',\n\
    \  event_type: 'view',\n  traffic_scope: 'all',\n  test: true,\n  debug: true,\n\
    });\n\nconst expected = 'https://www.example.com/test?timestamp=321&session_id=1234.1234&event_type=view&v=964964e&attr_window=90&ref_host=google.com&ref_path=/job_123.html&curr_host=example.com&curr_path=/job_123.html&job_id=test_id_123&brand=test_for_template&t=all';\n\
    \nmock('getCookieValues', (name) => {\n  if (name === session) {\n    return ['1234.1234'];\n\
    \  }\n  if (name === params) { \n    return [getUrlData.params_empty];\n  }\n\
    });\n\nmock('getUrl', component => {\n  if (component === 'query') {\n    return\
    \ getUrlData.params_empty;\n  } else if (component === 'host') {\n    return getUrlData.curr_host;\n\
    \  } else if (component === 'path') {\n    return getUrlData.curr_path;\n  } fail(\"\
    getUrl failed\");\n});\n\nmock('getReferrerUrl', component => {\n  if (component\
    \ === 'host') {\n    return getReferrerData.ref_host;\n  } else if (component\
    \ === 'path') {\n    return getReferrerData.ref_path;\n  } fail(\"getReferrer\
    \ failed\");\n});\n\nmock('setCookie', (name, value, options) => {\n  if (name\
    \ === session) {\n    cookies[name] = value;\n  }\n  if (name === params) {\n\
    \    cookies[name] = value;\n  }\n});\n\nmock('sendPixel', (url, gtmOnSuccess,\
    \ gtmOnFailure) => {              \n  assertThat(url).isEqualTo(expected);\n \
    \ gtmOnSuccess();\n});\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('setCookie').wasCalledWith(session, cookies[session], cookieOptionsSession);\n\
    assertApi('setCookie').wasNotCalledWith(params, cookies[params], cookieOptionsParams);"
- name: unitTestFunctionBuildUrlEmptyJobId
  code: "const mockData = getMockData({\n  event_type: 'view',\n  debug: true,\n \
    \ platformParameters: [\n      {\n        key: 'job_id',\n        value: undefined\n\
    \      }\n    ],\n});\n\nconst expected = 'https://www.example.com?timestamp=321&session_id=1234.1234&event_type=view&v=964964e&attr_window=90&ref_host=google.com&ref_path=/job_123.html&curr_host=example.com&curr_path=/job_123.html&job_id=unknown&utm_source=test&utm_medium=test&aw_id=123&t=aimwel';\n\
    \nmock('getCookieValues', (name) => {\n  if (name === session) {\n    return [undefined];\n\
    \  }\n  if (name === params) { \n    return [undefined];\n  }\n});\n\nmock('getUrl',\
    \ component => {\n  if (component === 'query') {\n    return getUrlData.params_full;\n\
    \  } else if (component === 'host') {\n    return getUrlData.curr_host;\n  } else\
    \ if (component === 'path') {\n    return getUrlData.curr_path;\n  } fail(\"getUrl\
    \ failed\");\n});\n\nmock('getReferrerUrl', component => {\n  if (component ===\
    \ 'host') {\n    return getReferrerData.ref_host;\n  } else if (component ===\
    \ 'path') {\n    return getReferrerData.ref_path;\n  } fail(\"getReferrer failed\"\
    );\n});\n\nmock('setCookie', (name, value, options) => {\n  if (name === session)\
    \ {\n    cookies[name] = value;\n  }\n  if (name === params) {\n    cookies[name]\
    \ = value;\n  }\n});\n\nmock('sendPixel', (url, gtmOnSuccess, gtmOnFailure) =>\
    \ {              \n  assertThat(url).isEqualTo(expected);\n  gtmOnSuccess();\n\
    });\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\nassertApi('setCookie').wasCalledWith(session,\
    \ cookies[session], cookieOptionsSession);\nassertApi('setCookie').wasCalledWith(params,\
    \ cookies[params], cookieOptionsParams);"
setup: "const logToConsole = require(\"logToConsole\");\n\nconst session = '_aimwel_session';\n\
  const params = '_aimwel_params';\n\nconst getMockData = (obj) => {\n  const mockData\
  \ = {\n    aimwel_api_endpoint: 'https://www.example.com',\n    platformParameters:\
  \ [\n      {\n        key: 'job_id',\n        value: 'test_id_123'\n      },\n \
  \     {\n        key: 'brand',\n        value: 'test_for_template'\n      }\n  \
  \  ],\n    url_params_storage_duration_days: \"90\",\n  };\n  \n  // add new keys\
  \ or override existing keys with input obj\n  for (var key in obj) {\n    mockData[key]\
  \ = obj[key];\n  }\n  \n  return mockData;\n};\n\nconst getUrlData = {\n  params_full:\
  \ 'utm_source=test&utm_medium=test&aw_id=123',\n  params_awid: 'aw_id=123',\n  params_utm:\
  \ 'utm_source=test&utm_medium=test',\n  params_alt_full: 'utm_source=example&utm_medium=example&aw_id=456',\n\
  \  params_alt_awid: 'aw_id=456',\n  params_alt_utm: 'utm_source=example&utm_medium=example',\n\
  \  params_empty: '',\n  curr_host: 'example.com',\n  curr_path: '/job_123.html',\n\
  };\n\nconst getReferrerData = {\n  ref_host: 'google.com',\n  ref_path: '/job_123.html',\n\
  };\n\nconst cookies = {};\n\nmock('getTimestampMillis', () => 321);\nmock('generateRandom',\
  \ () => 1234);\n\nconst cookieOptionsSession = {\n    domain: 'auto',\n    path:\
  \ '/',\n    'max-age': 30 * 60,\n    samesite: 'Lax',\n    secure: true\n  };\n\n\
  const cookieOptionsParams = {\n    domain: 'auto',\n    path: '/',\n    'max-age':\
  \ 90 * 24 * 60 * 60,\n    samesite: 'Lax',\n    secure: true\n  };"


___NOTES___

Created on 01/11/2023, 16:22:29



