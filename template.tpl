___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "categories": [
    "CONVERSIONS"
  ],
  "displayName": "Aimwel Conversion Measurement Tag",
  "brand": {
    "id": "github.com_Aimwel-OS",
    "displayName": "Aimwel Custom Template",
    "thumbnail": "data:image/jpeg;base64,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cmP1LANk7r7aIqxstCZjbSavYTh3T2cDckpwrmaWoddJjAC0HDkFjvCh6ToD6rkQKvCuQGSfXz2rDOv/AEjtUeiMeqdXzjOn/CO/4Qf0JhWMllObMeacuxGjYly1NKo2RPDyaMbgBRsy5aw4pL6Z0R3qz+Am252fhTKlkIbd4z+CZSVdhNICMhAKd3SgwuLtqTvLkgJRnpTaCZNQScYP5kdCpiAJKNWkigBLvVABcI1Z0RAXLvQku/w62UMZijPcoPGwMD7ehHelr96ATxMvJruHhpxPqiZ8sQEzENXOhudXo+vxg/oC37nPXq/38ZPiGNwK3DBpWgmlYoDkqGMDNitBhI0o8JSpAUhiDDbeS1BUPRn1xs9JxVNsZ3yEUmKN16SiMBc8GKZlYnKTGlHAZcwhAE5zThgEqkKgnrRcz1CCjzTwXXqEkD3U18pqxKO7WehssTIFrmdQkZY88ZPnZoqfoX07OldzS0rjVY8ryMRReCsiiwpzUKl5d9fwnilImW9JMcLPSfoyfQ/Y7+Gtr5w+lN5IKnnNECCz72oGwlZ0Lf3WXKT0IOFnpPmmGdnAfR0qMoRdhmLbopgw2YkVjlik3yl2GZFt2qOXfQGWOVK7QHux6SiqR62OxslB+5aPk2zRdJsFdASaLMHabzeAxes1aKjnovmz2h0wHOpdA2hzVNZIF0d3CjSYbQ5jUbcro5NA6UAI0AgCoh1ghGJdOapAEul4FAc55E6E/wBtZmWHK3lXvSiz0Q5KI86nBQDYJELukeP5K//aAAwDAQACAAMAAAAQ88888888888888888888888888888888888888888888888888888D1N7128888886c7BHfr8888d8sO4EF0WHDJ198888888bhjNM58888888svO/Os88888888888888888888888888888888888888888888888888888//EACMRAQACAgEDBAMAAAAAAAAAAAEAESExQSAwUBBR0fBhgaH/2gAIAQMBAT8Q8qy5qV8C1bHtFDcsC7m+vUF3ziZD4n1/qWKYIapwS9rjpyMVXoEjaZLZmIQBBiCYYgkGJ/L8RuAInAEVbVTJEpJv2BaD6S1XHZ9nxGKVMRrDN+wz8LlVBajjx/Ez5uWO8t//xAAoEQEAAgECBQMEAwAAAAAAAAABABEhMUFRgaHR8GGxwSAwUJEQceH/2gAIAQIBAT8Q/KoRG9F+btz0Wem3SNQBrsee8Vo2wpCvhEVT9YKoi+v3M8YG0D2/xnXnsyuRXK8+0MXjPftiWDRNPXtj6WCyp57/AMJhQb85xSptseLCNgDoeaVLCASz+hlogOThrL2Acn7nWwWVszw37QsrZXpv2nBIAa/M9OSZ0L8fYozdOa5JlNYim+/eIMpsx+4ycuiNVp7x5YOF0wOLnQvx9gpXDs6QTaN7VjznAqaaGxLmANLIUUA0DSU2JjO+Py3/xAAoEAEBAAIBAwMEAwADAAAAAAABEQAhMUFRYXGBoRAwkfAgcLFAwdH/2gAIAQEAAT8Q/soPFcYBy/Qe+abeLetvx3F84w5faIafQD2+gwHamJBdAbLzs4wxAd2/a75B6/8AE1oEk7l8hPzhnSOgq4HWOzkmbnUU7l8H5h9DaAZSJSLStWM4xV8zSFQgSInt9AHXcb8t0PKZoxAV/tUl8YbTdws7t0PMwila2v2VMfH32luA4hp9E+pYBnoJ3NHrafGaS1i6g19VjyP4ZrLhfCHztkg9IjYYS/rmHofrbl53i5yHTjHqCNC9xxi+4Rla7uLLzvExyTiuxGNYO9EcLJQt202+QT2+yOXabOxenmfwEXwQhq+DDOVL3FLRyPWYazaBlxvxJkbFoSZDTQZxi0yFY9k+uayx1Ug7W+PKLUTQV8wD2w4BxmwQvpXOn0ClKr5zT2HG4EvtlDMSXt9mekZqsMAegAAdtZuKSeqfVE+GmP8A66vCy2Ng1tEi56FdOOTceIR6md3bHzqySgkxpTnezNHKZpBz+0Hj+bNZJWUXvy+PysybsxjcBLFK8bw0w16j/HojsRHCdetE1BLCleNnfKZjfeF7IiI7ERyNIjgd1dBgAsAJvZuPznE370nVsfH0/Yd+frux9Vm7SSgAlwjH5wkygwEKCCrUNrr6TGZ8DAgtRCDswxP4miQArZWHQ6YATMhVBom4luiDlMfT6AJBQYs6ZDFQRDw0mhOdEt1dBIFG9RQUF5DEZeDiroBNolvEuPgjt0gKBQYqbmfL4/KzM0MFD3Y1asEuCbDCTpaxKVYJembXAyFkacppwovXUCJhAokLsUOOK5vZNlnCjyjTKvJjEuooKV5Gj6Z+w78/Xdj73y+Pys37zu+ij9f3YwFGS61f9YqFL4WAl87/ADhlCCAcDIjetdwVDwxJamntX4GvbP2Hfn67sfeKTLk4cF6KKd67YlgpmeUJIoaurhZI8UazfIoHrvpMaTIi/GNRUauqYRqiBoUvkULw7msCarsT8tu98iQct6gWkHXo4pBWSkFDiHSOxMZodO/Zj2jH/ZF0IoRW1INt3iFaqbqb4ChosJ6H3n8E4I/L6D8JR5xqT0R23SvopmxbwwyCyAdwGzkx77WgdaNcfRTCCAKGDeEdwpe5hy7EAiABwBiEmxnogcBohEAZzjrSjz7ab+MQfaii7DVfQP8AMK+/RNSHdS++IcKvIWDVMTonbDoCbkhBgV4+7+yv/9k\u003d"
  },
  "description": "Track Aimwel conversions effortlessly with our pixel for GTM",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "aimwel_api_endpoint",
    "displayName": "Aimwel API Endpoint URL (provided by Aimwel)",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "^https:\\/\\/[a-z]+\\.t2\\.aimwel\\.(com|net)$"
        ],
        "errorMessage": "URL must be of the following format \"https://{{client_name}}.t2.aimwel.com\""
      },
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Please enter the provided Aimwel API endpoint URL in this field",
    "notSetText": "Please add the API endpoint URL to this field",
    "valueHint": "https://{{client name}}.t2.aimwel.com",
    "alwaysInSummary": true
  },
  {
    "type": "RADIO",
    "name": "event_type",
    "displayName": "Event Type",
    "radioItems": [
      {
        "value": "apply",
        "displayValue": "Apply click"
      },
      {
        "value": "view",
        "displayValue": "Job view"
      },
      {
        "value": "finished_apply",
        "displayValue": "Finished apply"
      },
      {
        "value": "registration",
        "displayValue": "Registration"
      }
    ],
    "simpleValueType": true,
    "help": "Please select the applicable event type",
    "valueValidators": [
      {
        "type": "NON_EMPTY",
        "errorMessage": "A choice is required"
      }
    ]
  },
  {
    "type": "RADIO",
    "name": "traffic_scope",
    "displayName": "Traffic scoping",
    "radioItems": [
      {
        "value": "all",
        "displayValue": "All traffic"
      },
      {
        "value": "aimwel",
        "displayValue": "Aimwel traffic"
      }
    ],
    "simpleValueType": true,
    "help": "Select a option to either send all performance conversion events to the endpoint or only Aimwel events. Default is all traffic (as per Aimwel guidelines).",
    "defaultValue": "all",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "url_params_storage_duration_days",
    "displayName": "Attribution window",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": 30,
        "displayValue": "30 days"
      },
      {
        "value": 60,
        "displayValue": "60 days"
      },
      {
        "value": 90,
        "displayValue": "90 days"
      }
    ],
    "simpleValueType": true,
    "help": "The time period for the click-through attribution.",
    "defaultValue": 90,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "alwaysInSummary": true
  },
  {
    "type": "CHECKBOX",
    "name": "test",
    "checkboxText": "Enable testing template",
    "simpleValueType": true,
    "displayName": "Template testing feature",
    "help": "Select this option to enable the template conversion event testing feature. Test conversion can be viewed here: https://try-tapi.aimwel.com/results.html. Please enter your API endpoint URL (example: https://\u003cclient_name\u003e.t2.aimwel.com) as input into the input field and click the \u0027Load Data\u0027 button.",
    "defaultValue": false,
    "alwaysInSummary": true
  },
  {
    "type": "CHECKBOX",
    "name": "debug",
    "checkboxText": "Enable logging to console",
    "simpleValueType": true,
    "displayName": "Logging for debugging",
    "help": "Enable this option to see logging messages in the browser\u0027s console for easy configuration debugging",
    "alwaysInSummary": true,
    "defaultValue": false
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "platformParameters",
    "displayName": "Platform parameters",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Platform parameter name",
        "name": "key",
        "type": "SELECT",
        "selectItems": [
          {
            "value": "job_id",
            "displayValue": "Job Id"
          },
          {
            "value": "brand",
            "displayValue": "Brand"
          }
        ],
        "isUnique": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "defaultValue": "",
        "displayName": "Platform parameter value",
        "name": "value",
        "type": "TEXT",
        "valueHint": "Select the (datalayer) variables which contain the required platform parameters",
        "isUnique": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ],
    "newRowButtonText": "Click to add platform parameter(s)",
    "help": "In this section you can add the platform parameters that should be included in the conversion event",
    "notSetText": "Please select the necessary platform parameter from the drop-down list.",
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "TABLE_ROW_COUNT",
        "args": [
          2,
          2
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// GTM Sandboxed JavaScript APIs
const getUrl = require('getUrl');
const sendPixel = require('sendPixel');
const setCookie = require('setCookie');
const getCookieValues = require('getCookieValues');
const logToConsole = require('logToConsole');
const getReferrerUrl = require('getReferrerUrl');
const generateRandom = require('generateRandom');
const encodeUriComponent = require('encodeUriComponent');
const getTimestampMillis = require('getTimestampMillis');
const getContainerVersion = require('getContainerVersion');


// Constants
const PIXEL_VERSION = '__GIT_SHA__';
const SESSION_COOKIE = '_aimwel_session';
const PARAMS_COOKIE = '_aimwel_params';
const GA_COOKIE = '_ga';
const AW_ID = 'aw_id';
const UTM_SOURCE = 'utm_source';
const LOG_PREFIX = '[Aimwel] ';


// Config
const endpoint = data.aimwel_api_endpoint;
const eventType = data.event_type;
const trafficScope = data.traffic_scope;
const isTestMode = data.test;
const attrDays = (1 * data.url_params_storage_duration_days) || 90;
const log = data.debug ? logToConsole : function() {};


// Log configuration
log(LOG_PREFIX + 'Configuration:');
log(LOG_PREFIX + '  pixel_version: ' + PIXEL_VERSION);
log(LOG_PREFIX + '  endpoint: ' + endpoint);
log(LOG_PREFIX + '  event_type: ' + eventType);
log(LOG_PREFIX + '  traffic_scope: ' + trafficScope);
log(LOG_PREFIX + '  test_mode: ' + isTestMode);
log(LOG_PREFIX + '  attribution_days: ' + attrDays);

data.platformParameters.forEach(function(p) {
    log(LOG_PREFIX + '  ' + p.key + ': ' + p.value);
});


// Cookie configs
const sessionCookieOpts = {
    domain: 'auto',
    path: '/',
    samesite: 'Lax',
    secure: true
};

const paramsCookieOpts = {
    domain: 'auto',
    path: '/',
    'max-age': attrDays * 86400,
    samesite: 'Lax',
    secure: true
};


// Helpers
function contains(str, substr) {
    return str && str.indexOf(substr) !== -1;
}

function stripTrailingSlash(str) {
    return str && str.charAt(str.length - 1) === '/' ? str.substring(0, str.length - 1) : str;
}

function genSessionId() {
    return generateRandom(1000000, 9999999) + '.' + generateRandom(1000000, 9999999);
}


// Session management
const existingSessionId = getCookieValues(SESSION_COOKIE)[0];
const sessionId = existingSessionId || genSessionId();
const sessionStatus = existingSessionId ? '[EXISTING]' : '[NEW]';

log(LOG_PREFIX + 'Session ' + sessionStatus + ': ' + sessionId);

setCookie(SESSION_COOKIE, sessionId, sessionCookieOpts);


// Campaign params management
const campaignParamsBefore = getCookieValues(PARAMS_COOKIE)[0];

log(LOG_PREFIX + 'Campaign params (before): ' + (campaignParamsBefore || '(empty)'));

const urlParams = getUrl('query');
const urlHasParams = contains(urlParams, AW_ID) || contains(urlParams, UTM_SOURCE);

let campaignParams = campaignParamsBefore;

if (urlHasParams) {
    setCookie(PARAMS_COOKIE, urlParams, paramsCookieOpts);

    campaignParams = urlParams;

    log(LOG_PREFIX + 'Campaign params (after): ' + campaignParams + ' [UPDATED FROM URL]');
} else if (campaignParams) {
    log(LOG_PREFIX + 'Campaign params (after): ' + campaignParams + ' [UNCHANGED]');
} else {
    log(LOG_PREFIX + 'Campaign params (after): (empty) [NO PARAMS]');
}


// Flags
const hasAwId = contains(campaignParams, AW_ID);
const hasUtm = contains(campaignParams, UTM_SOURCE);


// Google Analytics cookie
const gaCookie = getCookieValues(GA_COOKIE)[0];

log(LOG_PREFIX + 'GA cookie: ' + (gaCookie || '(not set)'));


// Build URL
function buildUrl() {
    const cv = getContainerVersion();

    let url = stripTrailingSlash(endpoint) + (isTestMode ? '/test' : '') +
        '?timestamp=' + getTimestampMillis() +
        '&session_id=' + sessionId +
        '&event_type=' + eventType +
        '&px_v=' + PIXEL_VERSION +
        '&cv_id=' + cv.containerId +
        '&cv_v=' + cv.version +
        '&cv_env=' + (cv.environmentName || '') +
        '&cv_dm=' + cv.debugMode +
        '&cv_pm=' + cv.previewMode +
        '&attr_window=' + attrDays +
        '&ref_host=' + getReferrerUrl('host') +
        '&ref_path=' + getReferrerUrl('path') +
        '&curr_host=' + getUrl('host') +
        '&curr_path=' + getUrl('path');

    data.platformParameters.forEach(function(p) {
        url += '&' + encodeUriComponent(p.key) + '=' + encodeUriComponent(p.value || 'unknown');
    });

    if (campaignParams) {
        url += '&' + campaignParams;
    }

    if (gaCookie) {
        url += '&_ga=' + encodeUriComponent(gaCookie);
    }

    return url;
}


// Send pixel
function send(trafficType) {
    const url = buildUrl() + '&t=' + trafficType;

    log(LOG_PREFIX + 'Traffic type: ' + trafficType);
    log(LOG_PREFIX + 'Request URL: ' + url);

    sendPixel(url, function() {
        log(LOG_PREFIX + 'Result: SUCCESS');

        data.gtmOnSuccess();
    }, function() {
        log(LOG_PREFIX + 'Result: FAILED');

        data.gtmOnFailure();
    });
}


// Execute
if (hasAwId) {
    send('aimwel');
} else if (trafficScope === 'all' && (hasUtm || !campaignParams)) {
    send('all');
} else {
    log(LOG_PREFIX + 'Traffic type: (none)');
    log(LOG_PREFIX + 'Result: NOT SENT - traffic scope is "aimwel" but no aw_id found');

    data.gtmOnSuccess();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "path",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "query",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "host",
          "value": {
            "type": 8,
            "boolean": true
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_aimwel_session"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_aimwel_params"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_referrer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "path",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "host",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: attributionWindow_allValues
  code: |-
    // Attribution window: test all values (30, 60, 90 days)

    function testAttributionWindow(days) {
        setupSharedMocks();
        mockCookies(null, null);
        mockGetUrl(urlData.params_full);

        const mockData = getMockData({
            url_params_storage_duration_days: '' + days
        });

        const expectedCookieOptions = {
            domain: 'auto',
            path: '/',
            'max-age': days * 24 * 60 * 60,
            samesite: 'Lax',
            secure: true
        };

        mock('sendPixel', function(url, onSuccess, onFailure) {
            assertThat(url.indexOf('&attr_window=' + days)).isGreaterThan(-1);
            onSuccess();
        });

        runCode(mockData);

        assertApi('gtmOnSuccess').wasCalled();
        assertApi('setCookie').wasCalledWith(PARAMS_COOKIE, urlData.params_full, expectedCookieOptions);
    }

    // Test all attribution window values
    testAttributionWindow(30);
    testAttributionWindow(60);
    testAttributionWindow(90);
- name: emptyReferrer_urlStillBuilds
  code: |
    // Empty referrer: URL should still build correctly

    setupSharedMocks();
    mockCookies(null, null);
    mockGetUrl(urlData.params_full);

    // Override referrer to be empty
    mock('getReferrerUrl', function(component) {
        return '';
    });

    const mockData = getMockData({});

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url.indexOf('&ref_host=')).isGreaterThan(-1);
        assertThat(url.indexOf('&ref_path=')).isGreaterThan(-1);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
- name: eventType_allValues
  code: |
    // Event type: test all values (view, apply, finished_apply, registration)

    function testEventType(eventType) {
        setupSharedMocks();
        mockCookies(null, null);
        mockGetUrl(urlData.params_full);

        const mockData = getMockData({
            event_type: eventType
        });

        mock('sendPixel', function(url, onSuccess, onFailure) {
            assertThat(url.indexOf('&event_type=' + eventType)).isGreaterThan(-1);
            onSuccess();
        });

        runCode(mockData);

        assertApi('gtmOnSuccess').wasCalled();
        assertApi('sendPixel').wasCalled();
    }

    // Test all event types
    testEventType('view');
    testEventType('apply');
    testEventType('finished_apply');
    testEventType('registration');
- name: gaCookie_excludedWhenMissing
  code: |
    // GA cookie: excluded from request when not present

    setupSharedMocks();
    mockCookies(null, null, null);
    mockGetUrl(urlData.params_full);

    const mockData = getMockData({});

    const expected = buildExpectedUrl({
        campaignParams: urlData.params_full,
        gaValue: '',
        trafficType: 'aimwel'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        assertThat(url.indexOf('&_ga=')).isEqualTo(-1);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
- name: gaCookie_includedWhenPresent
  code: |
    // GA cookie: included in request when present

    setupSharedMocks();
    mockCookies(null, null, 'GA1.2.123456789.1234567890');
    mockGetUrl(urlData.params_full);

    const mockData = getMockData({});

    const expected = buildExpectedUrl({
        campaignParams: urlData.params_full,
        gaValue: 'GA1.2.123456789.1234567890',
        trafficType: 'aimwel'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        assertThat(url.indexOf('&_ga=GA1.2.123456789.1234567890')).isGreaterThan(-1);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
- name: newUser_awIdAndUtm_noCookie_trafficAimwel_sendsAimwel
  code: |
    // New user with aw_id + utm in URL, traffic_scope=aimwel -> sends aimwel (aw_id present)

    setupSharedMocks();
    mockCookies(null, null);
    mockGetUrl(urlData.params_full);

    const mockData = getMockData({
        traffic_scope: 'aimwel'
    });

    const expected = buildExpectedUrl({
        campaignParams: urlData.params_full,
        trafficType: 'aimwel'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
- name: newUser_awIdAndUtm_noCookie_trafficAll_sendsAimwel
  code: |
    // New user with aw_id + utm params in URL -> sends as aimwel traffic

    setupSharedMocks();
    mockCookies(null, null);
    mockGetUrl(urlData.params_full);

    const mockData = getMockData({});

    const expected = buildExpectedUrl({
        campaignParams: urlData.params_full,
        trafficType: 'aimwel'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
    assertApi('setCookie').wasCalledWith(SESSION_COOKIE, cookies[SESSION_COOKIE], cookieOptionsSession);
    assertApi('setCookie').wasCalledWith(PARAMS_COOKIE, urlData.params_full, cookieOptionsParams);
- name: newUser_awIdOnly_noCookie_trafficAimwel_sendsAimwel
  code: |
    // New user with only aw_id in URL, traffic_scope=aimwel -> sends aimwel

    setupSharedMocks();
    mockCookies(null, null);
    mockGetUrl(urlData.params_awid);

    const mockData = getMockData({
        traffic_scope: 'aimwel'
    });

    const expected = buildExpectedUrl({
        campaignParams: urlData.params_awid,
        trafficType: 'aimwel'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
- name: newUser_awIdOnly_noCookie_trafficAll_sendsAimwel
  code: |
    // New user with only aw_id in URL (no utm) -> sends as aimwel traffic

    setupSharedMocks();
    mockCookies(null, null);
    mockGetUrl(urlData.params_awid);

    const mockData = getMockData({});

    const expected = buildExpectedUrl({
        campaignParams: urlData.params_awid,
        trafficType: 'aimwel'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
    assertApi('setCookie').wasCalledWith(PARAMS_COOKIE, urlData.params_awid, cookieOptionsParams);
- name: newUser_noParams_noCookie_trafficAimwel_notSent
  code: |
    // New user with no URL params, traffic_scope=aimwel -> does NOT send

    setupSharedMocks();
    mockCookies(null, null);
    mockGetUrl(urlData.params_empty);

    const mockData = getMockData({
        traffic_scope: 'aimwel'
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasNotCalled();
- name: newUser_noParams_noCookie_trafficAll_sendsAll
  code: |
    // New user with no URL params, traffic_scope=all -> sends as all traffic

    setupSharedMocks();
    mockCookies(null, null);
    mockGetUrl(urlData.params_empty);

    const mockData = getMockData({
        traffic_scope: 'all'
    });

    const expected = buildExpectedUrl({
        campaignParams: '',
        trafficType: 'all'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
    assertApi('setCookie').wasNotCalledWith(PARAMS_COOKIE, cookies[PARAMS_COOKIE], cookieOptionsParams);
- name: newUser_utmOnly_noCookie_trafficAimwel_notSent
  code: |
    // New user with only utm params, traffic_scope=aimwel -> does NOT send (no aw_id)

    setupSharedMocks();
    mockCookies(null, null);
    mockGetUrl(urlData.params_utm);

    const mockData = getMockData({
        traffic_scope: 'aimwel'
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasNotCalled();
    assertApi('setCookie').wasCalledWith(PARAMS_COOKIE, urlData.params_utm, cookieOptionsParams);
- name: newUser_utmOnly_noCookie_trafficAll_sendsAll
  code: |
    // New user with only utm params, traffic_scope=all -> sends as all traffic

    setupSharedMocks();
    mockCookies(null, null);
    mockGetUrl(urlData.params_utm);

    const mockData = getMockData({
        traffic_scope: 'all'
    });

    const expected = buildExpectedUrl({
        campaignParams: urlData.params_utm,
        trafficType: 'all'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
    assertApi('setCookie').wasCalledWith(PARAMS_COOKIE, urlData.params_utm, cookieOptionsParams);
- name: returningUser_awIdAndUtmUrl_awIdAndUtmCookie_trafficAll_sendsAimwel
  code: |
    // Returning user: same aw_id+utm in both URL and cookie -> sends aimwel, cookie updated

    setupSharedMocks();
    mockCookies('existing.session', urlData.params_alt_full);  // Cookie has old params
    mockGetUrl(urlData.params_full);  // URL has new params

    const mockData = getMockData({
        traffic_scope: 'all'
    });

    const expected = buildExpectedUrl({
        sessionId: 'existing.session',
        campaignParams: urlData.params_full,
        trafficType: 'aimwel'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
    assertApi('setCookie').wasCalledWith(PARAMS_COOKIE, urlData.params_full, cookieOptionsParams);
- name: returningUser_awIdAndUtmUrl_utmCookie_trafficAll_sendsAimwel
  code: |
    // Returning user: URL params override cookie params, sends aimwel

    setupSharedMocks();
    mockCookies('existing.session', urlData.params_alt_utm);  // Cookie has old utm params
    mockGetUrl(urlData.params_full);  // URL has new aw_id + utm

    const mockData = getMockData({});

    const expected = buildExpectedUrl({
        sessionId: 'existing.session',
        campaignParams: urlData.params_full,  // URL params used, not cookie
        trafficType: 'aimwel'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
    assertApi('setCookie').wasCalledWith(PARAMS_COOKIE, urlData.params_full, cookieOptionsParams);
- name: returningUser_awIdUrl_utmCookie_trafficAll_sendsAimwel
  code: |
    // Returning user: aw_id URL overwrites utm cookie -> sends aimwel (gains aw_id)

    setupSharedMocks();
    mockCookies('existing.session', urlData.params_utm);  // Cookie has only utm
    mockGetUrl(urlData.params_awid);  // URL has aw_id

    const mockData = getMockData({
        traffic_scope: 'all'
    });

    const expected = buildExpectedUrl({
        sessionId: 'existing.session',
        campaignParams: urlData.params_awid,
        trafficType: 'aimwel'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
    assertApi('setCookie').wasCalledWith(PARAMS_COOKIE, urlData.params_awid, cookieOptionsParams);
- name: returningUser_noUrl_awIdAndUtmCookie_trafficAimwel_sendsAimwel
  code: |
    // Returning user: no URL params, aw_id+utm in cookie, traffic_scope=aimwel -> sends aimwel

    setupSharedMocks();
    mockCookies('existing.session', urlData.params_full);
    mockGetUrl(urlData.params_empty);

    const mockData = getMockData({
        traffic_scope: 'aimwel'
    });

    const expected = buildExpectedUrl({
        sessionId: 'existing.session',
        campaignParams: urlData.params_full,
        trafficType: 'aimwel'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
- name: returningUser_noUrl_awIdAndUtmCookie_trafficAll_sendsAimwel
  code: |
    // Returning user: no URL params, aw_id+utm in cookie -> sends aimwel

    setupSharedMocks();
    mockCookies('existing.session', urlData.params_full);
    mockGetUrl(urlData.params_empty);

    const mockData = getMockData({
        traffic_scope: 'all'
    });

    const expected = buildExpectedUrl({
        sessionId: 'existing.session',
        campaignParams: urlData.params_full,
        trafficType: 'aimwel'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
- name: returningUser_noUrl_awIdCookie_trafficAimwel_sendsAimwel
  code: |
    // Returning user: no URL params, aw_id only in cookie, traffic_scope=aimwel -> sends aimwel

    setupSharedMocks();
    mockCookies('existing.session', urlData.params_awid);
    mockGetUrl(urlData.params_empty);

    const mockData = getMockData({
        traffic_scope: 'aimwel'
    });

    const expected = buildExpectedUrl({
        sessionId: 'existing.session',
        campaignParams: urlData.params_awid,
        trafficType: 'aimwel'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
- name: returningUser_noUrl_awIdCookie_trafficAll_sendsAimwel
  code: |
    // Returning user: no URL params, aw_id in cookie -> sends as aimwel

    setupSharedMocks();
    mockCookies('existing.session', urlData.params_awid);
    mockGetUrl(urlData.params_empty);

    const mockData = getMockData({});

    const expected = buildExpectedUrl({
        sessionId: 'existing.session',
        campaignParams: urlData.params_awid,
        trafficType: 'aimwel'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
- name: returningUser_noUrl_utmCookie_trafficAimwel_notSent
  code: |
    // Returning user: no URL params, utm only in cookie, traffic_scope=aimwel -> NOT sent

    setupSharedMocks();
    mockCookies('existing.session', urlData.params_utm);
    mockGetUrl(urlData.params_empty);

    const mockData = getMockData({
        traffic_scope: 'aimwel'
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasNotCalled();
- name: returningUser_noUrl_utmCookie_trafficAll_sendsAll
  code: |
    // Returning user: no URL params, utm only in cookie, traffic_scope=all -> sends all

    setupSharedMocks();
    mockCookies('existing.session', urlData.params_utm);
    mockGetUrl(urlData.params_empty);

    const mockData = getMockData({
        traffic_scope: 'all'
    });

    const expected = buildExpectedUrl({
        sessionId: 'existing.session',
        campaignParams: urlData.params_utm,
        trafficType: 'all'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
- name: returningUser_utmUrl_awIdCookie_trafficAll_sendsAll
  code: |
    // Returning user: utm URL overwrites aw_id cookie -> sends all (loses aw_id!)
    // This is an important edge case: new UTM params replace old aw_id attribution

    setupSharedMocks();
    mockCookies('existing.session', urlData.params_awid);  // Cookie has aw_id
    mockGetUrl(urlData.params_utm);  // URL has only utm (no aw_id)

    const mockData = getMockData({
        traffic_scope: 'all'
    });

    const expected = buildExpectedUrl({
        sessionId: 'existing.session',
        campaignParams: urlData.params_utm,  // UTM from URL, aw_id lost
        trafficType: 'all'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
    assertApi('setCookie').wasCalledWith(PARAMS_COOKIE, urlData.params_utm, cookieOptionsParams);
- name: sendPixelFailure_callsGtmOnFailure
  code: |
    // When sendPixel fails, gtmOnFailure should be called

    setupSharedMocks();
    mockCookies(null, null);
    mockGetUrl(urlData.params_full);

    const mockData = getMockData({});

    mock('sendPixel', function(url, onSuccess, onFailure) {
        onFailure();  // Simulate request failure
    });

    runCode(mockData);

    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: sessionExtended_returningUser
  code: |
    // Returning user: session cookie is extended (setCookie called with existing session)

    setupSharedMocks();
    mockCookies('existing.session.id', null);
    mockGetUrl(urlData.params_empty);

    const mockData = getMockData({
        traffic_scope: 'all'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url.indexOf('&session_id=existing.session.id')).isGreaterThan(-1);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('setCookie').wasCalledWith(SESSION_COOKIE, 'existing.session.id', cookieOptionsSession);
- name: testMode_appendsTestPath
  code: |
    // Test mode enabled -> /test path appended to endpoint

    setupSharedMocks();
    mockCookies(null, null);
    mockGetUrl(urlData.params_empty);

    const mockData = getMockData({
        test: true,
        traffic_scope: 'all'
    });

    const expected = buildExpectedUrl({
        testMode: true,
        campaignParams: '',
        trafficType: 'all'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        assertThat(url).isEqualTo(expected);
        assertThat(url.indexOf('/test?')).isGreaterThan(-1);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
- name: trailingSlash_strippedFromEndpoint
  code: |
    // Trailing slash: should be stripped from endpoint URL

    setupSharedMocks();
    mockCookies(null, null);
    mockGetUrl(urlData.params_full);

    const mockData = getMockData({
        aimwel_api_endpoint: 'https://test.t2.aimwel.com/'
    });

    mock('sendPixel', function(url, onSuccess, onFailure) {
        // Should NOT have double slash
        assertThat(url.indexOf('aimwel.com//')).isEqualTo(-1);
        // Should start with correct URL (no trailing slash before query)
        assertThat(url.indexOf('https://test.t2.aimwel.com?')).isGreaterThan(-1);
        onSuccess();
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('sendPixel').wasCalled();
setup: |-
  // Shared test setup for GTM template tests

  const logToConsole = require("logToConsole");

  // Cookie names
  const SESSION_COOKIE = '_aimwel_session';
  const PARAMS_COOKIE = '_aimwel_params';
  const GA_COOKIE = '_ga';

  // Cookie options (must match pixel.js)
  const cookieOptionsSession = {
      domain: 'auto',
      path: '/',
      samesite: 'Lax',
      secure: true
  };

  const cookieOptionsParams = {
      domain: 'auto',
      path: '/',
      'max-age': 90 * 24 * 60 * 60,
      samesite: 'Lax',
      secure: true
  };

  // Test data
  const urlData = {
      params_full: 'utm_source=test&utm_medium=test&aw_id=123',
      params_awid: 'aw_id=123',
      params_utm: 'utm_source=test&utm_medium=test',
      params_alt_full: 'utm_source=example&utm_medium=example&aw_id=456',
      params_alt_awid: 'aw_id=456',
      params_alt_utm: 'utm_source=example&utm_medium=example',
      params_empty: '',
      curr_host: 'example.com',
      curr_path: '/job_123.html',
  };

  const referrerData = {
      ref_host: 'google.com',
      ref_path: '/search',
  };

  // Cookie storage for tests
  const cookies = {};

  // Base mock data factory
  function getMockData(overrides) {
      const defaults = {
          aimwel_api_endpoint: 'https://test.t2.aimwel.com',
          event_type: 'view',
          traffic_scope: 'all',
          test: false,
          debug: true,
          url_params_storage_duration_days: '90',
          platformParameters: [
              { key: 'job_id', value: 'job_123' },
              { key: 'brand', value: 'test_brand' }
          ]
      };

      for (var key in overrides) {
          defaults[key] = overrides[key];
      }

      return defaults;
  }

  // Shared mocks (called in each test's setup)
  function setupSharedMocks() {
      mock('getTimestampMillis', function() { return 1000; });
      mock('generateRandom', function() { return 1234; });
      mock('getContainerVersion', function() {
          return {
              containerId: 'GTM-TEST123',
              version: '1',
              environmentName: '',
              debugMode: false,
              previewMode: false
          };
      });

      mock('getReferrerUrl', function(component) {
          if (component === 'host') return referrerData.ref_host;
          if (component === 'path') return referrerData.ref_path;
          return '';
      });

      mock('setCookie', function(name, value, options) {
          cookies[name] = value;
      });
  }

  // Helper to mock getUrl with specific query params
  function mockGetUrl(queryParams) {
      mock('getUrl', function(component) {
          if (component === 'query') return queryParams;
          if (component === 'host') return urlData.curr_host;
          if (component === 'path') return urlData.curr_path;
          return '';
      });
  }

  // Helper to mock getCookieValues
  function mockCookies(sessionId, paramsValue, gaValue) {
      mock('getCookieValues', function(name) {
          if (name === SESSION_COOKIE) return sessionId ? [sessionId] : [undefined];
          if (name === PARAMS_COOKIE) return paramsValue ? [paramsValue] : [undefined];
          if (name === GA_COOKIE) return gaValue ? [gaValue] : [undefined];
          return [undefined];
      });
  }

  // Helper to build expected URL
  function buildExpectedUrl(options) {
      var endpoint = options.endpoint || 'https://test.t2.aimwel.com';
      var testMode = options.testMode || false;
      var sessionId = options.sessionId || '1234.1234';
      var eventType = options.eventType || 'view';
      var attrWindow = options.attrWindow || 90;
      var jobId = options.jobId || 'job_123';
      var brand = options.brand || 'test_brand';
      var campaignParams = options.campaignParams || '';
      var gaValue = options.gaValue || '';
      var trafficType = options.trafficType || 'all';

      var url = endpoint + (testMode ? '/test' : '') +
          '?timestamp=1000' +
          '&session_id=' + sessionId +
          '&event_type=' + eventType +
          '&px_v=__GIT_SHA__' +
          '&cv_id=GTM-TEST123' +
          '&cv_v=1' +
          '&cv_env=' +
          '&cv_dm=false' +
          '&cv_pm=false' +
          '&attr_window=' + attrWindow +
          '&ref_host=' + referrerData.ref_host +
          '&ref_path=' + referrerData.ref_path +
          '&curr_host=' + urlData.curr_host +
          '&curr_path=' + urlData.curr_path +
          '&job_id=' + jobId +
          '&brand=' + brand;

      if (campaignParams) {
          url += '&' + campaignParams;
      }

      if (gaValue) {
          url += '&_ga=' + gaValue;
      }

      url += '&t=' + trafficType;

      return url;
  }


___NOTES___

Created on 01/11/2023, 16:22:29


